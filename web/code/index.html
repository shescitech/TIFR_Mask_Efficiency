<!-- A webpage to show particle count data -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Corona :)</title>
    <style type="text/css">
      body{
        margin:0px;
        padding:0px;
        margin-left:auto;
        margin-right:auto;
      }
      .container{
        width:100%;
        max-width:800px;
        margin-left:auto;
        margin-right:auto;
      }
      .chart-container{
        border: 1px solid #dfe1e5;
        border-radius: 8px;
        box-shadow: none;
        margin-top:20px;
        padding:20px;
      }
      .startContainer{
        position:absolute;
        height:100%;
        width:100%;
        background-color:rgba(0,0,0,0.5);
        display:flex;
        align-items: center;
        justify-content: center;
      }
      .startCircle{
        height:150px;
        width:150px;
        border-style: solid;
        border-radius:50%;
        border-width: 10px;
        border-color: rgba(255, 255, 255, 0.8);
        background-color:#4CAF50;
        text-align:center;
        display:flex;
        align-items: center;
        justify-content: center;
        color:rgba(255,255,255,0.8);
        font-size:1.5rem;
      }
      .startCircle:hover{
        background-color:#4CBF50;
        color:rgba(255,255,255,1);
        cursor:pointer;
      }
      .d-none{
        display:none;
      }
      .myChart{
        width:100%;
      }

      .downloadBtn{
        margin: 20px 0;
        padding: 10px 20px;
        width:200px;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.5);
        font-size: 1.3em;
        border-radius: 5px;
      }
      .downloadBtn:hover{
        cursor: pointer;
        background-color: rgba(0, 0, 0, 0.6);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js"></script>
    <script type="text/javascript">
      //Supporting functions
      function getClass(className){
         return document.getElementsByClassName(className)[0]
      }

      function downloadFile(data, fileName, type="text/plain") {
        const a = document.createElement("a");
        a.style.display = "none";
        document.body.appendChild(a);
        a.href = window.URL.createObjectURL(
          new Blob([data], { type })
        );
        a.setAttribute("download", fileName);
        a.click();
        window.URL.revokeObjectURL(a.href);
        document.body.removeChild(a);
      }
    </script>
    <script type="text/javascript">
      // Static variable definition
      var staticData={
        ip:'192.168.0.185',
        refreshRate: 10000
      }
      window.onload=init;
      var initialTime = new Date();
      initialData={
        time:initialTime.getTime()
      }
      dataHub=[];
      indiData={
        NP_0point3: [],
        NP_0point5: [],
        NP_1point0: [],
        NP_2point5: [],
        NP_5point0: [],
        NP_10: [],
        PM1point0_ATM: [],
        PM1point0_CF: [],
        PM2point0_CF: [],
        PM2point5_ATM: [],
        PM10_ATM: [],
        PM10_CF: [],
        Time_passed: [],
        my_time:[]
      }
      index=0


      function init(){
        getClass('startCircle').addEventListener('click', startProcess, false);
        getClass('i-particle-dimension').addEventListener('change', changeGraph, false);
        getClass('downloadBtn').addEventListener('click', downloadData, false);
        getClass('downloadAllBtn').addEventListener('click', downloadAllData, false);
      }
      function startProcess(){
        getClass('startContainer').classList.toggle('d-none');
        getClass('container').classList.toggle('d-none');
        plot(indiData.my_time, indiData.NP_0point3, 'My Plot')
        getData();
        window.setInterval(function(){
          getData()
        }, staticData.refreshRate)

      }
      async function getData(){
        var latestdata= await axios.get('https://'+staticData.ip);
        console.log(latestdata.data)
        addData(latestdata.data)
        return latestdata.data;
      }

      function addData(latestData){

        dataHub.push(latestData);
        indiData.NP_0point3.push(latestData['NP_0.3']),
        indiData.NP_0point5.push(latestData['NP_0.5']),
        indiData.NP_1point0.push(latestData['NP_1.0']),
        indiData.NP_2point5.push(latestData['NP_2.5']),
        indiData.NP_5point0.push(latestData['NP_5.0']),
        indiData.NP_10.push(latestData['NP_10']),
        indiData.PM1point0_ATM.push(latestData['PM1.0_ATM']),
        indiData.PM1point0_CF.push(latestData['PM1.0_CF']),
        indiData.PM2point0_CF.push(latestData['PM2.0_CF']),
        indiData.PM2point5_ATM.push(latestData['PM2.5_ATM']),
        indiData.PM10_ATM.push(latestData['PM10_ATM']),
        indiData.PM10_CF.push(latestData['PM10_CF']),
        indiData.Time_passed.push(latestData['Time_passed'])
        var d = new Date();
        var n = d.getTime();

        var timeinSec=Math.round((n-initialData.time)/1000)
        console.log(timeinSec);
        indiData.my_time.push(timeinSec)
        addDataToPlot(chart, timeinSec, latestData['NP_0.3'])
      }


      function plot(labels, dataPoint, label){
        console.log('Hello');
        var ctx = document.getElementById('myChart').getContext('2d');
         chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: label,
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: 'rgb(100, 99, 255)',
              data: dataPoint
            },
            // {
            //   label: label,
            //   backgroundColor: 'rgba(255, 0, 0, 1)',
            //   borderColor: 'rgb(100, 99, 255)',
            //   data: dataPoint
            // }
          ]
          },
          // Configuration options go here
            options: {tooltips: {mode: 'x'}}
          });
      }

      function addDataToPlot(chart, label, data) {
        //chart.data.labels.push(label);
        //chart.data.datasets[0].data.push(data);
        chart.update();
      }

      function changeGraph() {
        var currentParticleDimension=getClass('i-particle-dimension').value;
        chart.data.labels=indiData.my_time;
        chart.data.datasets[0].data=indiData[currentParticleDimension];
        chart.update();
      }

      function downloadData(){
        var currentParticleDimension=getClass('i-particle-dimension').value;
        var totalData=''
        for (var i = 0; i < indiData['NP_0point3'].length; i++) {
          totalData=totalData+indiData[currentParticleDimension][i]
          totalData=totalData+ ', '+indiData['my_time'][i]
          totalData=totalData+ '\n';
        }
        downloadFile(totalData, 'a.txt')
      }

      function downloadAllData(){
        var totalData=''
        for (var i = 0; i < indiData['NP_0point3'].length; i++) {
          totalData=totalData+indiData['NP_0point3'][i]
          totalData=totalData+ ', '+indiData['NP_0point5'][i]
          totalData=totalData+ ', '+indiData['NP_1point0'][i]
          totalData=totalData+ ', '+indiData['NP_2point5'][i]
          totalData=totalData+ ', '+indiData['NP_5point0'][i]
          totalData=totalData+ ', '+indiData['NP_10'][i]
          totalData=totalData+ ', '+indiData['PM1point0_ATM'][i]
          totalData=totalData+ ', '+indiData['PM1point0_CF'][i]
          totalData=totalData+ ', '+indiData['PM2point0_CF'][i]
          totalData=totalData+ ', '+indiData['PM2point5_ATM'][i]
          totalData=totalData+ ', '+indiData['PM10_ATM'][i]
          totalData=totalData+ ', '+indiData['PM10_CF'][i]
          totalData=totalData+ ', '+indiData['Time_passed'][i]
          totalData=totalData+ ', '+indiData['my_time'][i]
          totalData=totalData+ '\n';
        }
        downloadFile(totalData, 'a.txt')
      }


    </script>
  </head>
  <body>
    <div class="wr">
      <div class="container d-none">
        <div class="viewOptions">
          <div class="configuration-text">
            Configuration
          </div>
          <div class="particle">
            Particle dimension:
            <select class="i-particle-dimension" name="i-particle-dimension">
              <option value="NP_0point3">NP_0point3</option>
              <option value="NP_0point5">NP_0point5</option>
              <option value="NP_1point0">NP_1point0</option>
              <option value="NP_2point5">NP_2point5</option>
              <option value="NP_5point0">NP_5point0</option>
              <option value="NP_10">NP_10</option>
              <option value="PM1point0_ATM">PM1point0_ATM</option>
              <option value="PM1point0_CF">PM1point0_CF</option>
              <option value="PM2point0_CF">PM2point0_CF</option>
              <option value="PM2point5_ATM">PM2point5_ATM</option>
              <option value="PM10_ATM">PM10_ATM</option>
              <option value="PM10_CF">PM10_CF</option>
            </select>
          </div>

          <div class="setting">
            <div class="setting-text">
              Setting
            </div>
            <div class="setting-options">
              <div class="setting-item">
                IP: <input class="i-ip" type="text" name="i-ip" value="192.168.0.185">
              </div>
              <div class="setting-item">
                RefreshRate (ms): <input class="i-refreshRate" type="text" name="i-refreshRate" value="10000">
              </div>
              <div class="setting-item">
                Graph colour: <input class="i-graphColour" type="text" name="i-graphColour" value="rgb(100, 99, 255)">
              </div>
              <div class="setting-item">
                Graph background colour: <input class="i-graphBgColour" type="text" name="i-graphBgColour" value="rgba(255, 255, 255, 0)">
              </div>
            </div>
            <div class="filters">
              <div class="filter-text">
                Add filters
              </div>
              <div class="filter-items">
                Filter items
              </div>
            </div>
          </div>
        </div>
        <div class="chart-container" style="position: relative; width:100%;">
          <canvas id="myChart"></canvas>
        </div>
        <div class="downloadData">
          <div class="downloadBtn">
            Download Current data
          </div>
          <div class="downloadAllBtn downloadBtn">
            Download All data
          </div>
        </div>
      </div>
      <div class="startContainer">
        <div class="startCircle">
          <div class="startBtn">
            Start
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
