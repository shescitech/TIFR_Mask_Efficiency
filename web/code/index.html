<!-- A webpage to show particle count data -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Mask Filtration Efficiency Tester</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style type="text/css">
      body{
        margin:0px;
        padding:0px;
        margin-left:auto;
        margin-right:auto;
      }
      .header{
        width: 100%;
        background-color: rgba(0,0,0,0.8);
        color: white;
        text-align: center;
        font-size: 1.8em;
        padding-top: 10px;
        padding-bottom: 10px;
      }
      .container-wr{
        width: 100%;
      }
      .container{
        width:100%;
        max-width:800px;
        margin-left:auto;
        margin-right:auto;
      }
      .container-inside{
        margin-left: 10px;
        margin-right: 10px;
      }
      .i-particle-dimension{
        width:300px;
        padding: 5px; 10px;
        margin-left: 10px;
        margin-right: 10px;
        background-color: rgba(50, 100, 0, 0.1);
        border-radius: 2px;
      }
      .particle{
        display: inline-flex;
        flex-wrap: wrap;
      }
      .particle-text{
        font-size: 1.1rem;
      }
      .advanced-setting-icon{
        width: 24px;
        margin-left: 20px;
        margin-right: 20px;
      }
      .data-running-icon{
          width: 24px;
      }
      .data-running-icon:hover{
        cursor: pointer;
      }
      .advanced-setting-icon:hover{
        cursor: pointer;
      }
      .chart-container{
        border: 1px solid #dfe1e5;
        border-radius: 8px;
        box-shadow: none;
        margin-top:20px;
        padding:20px;
        width: 93%;
      }
      .startContainer{
        position:absolute;
        height:100%;
        width:100%;
        background-color:rgba(0,0,0,0.5);
        display:flex;
        align-items: center;
        justify-content: center;
      }
      .startCircle{
        height:150px;
        width:150px;
        border-style: solid;
        border-radius:50%;
        border-width: 10px;
        border-color: rgba(255, 255, 255, 0.8);
        background-color:#4CAF50;
        text-align:center;
        display:flex;
        align-items: center;
        justify-content: center;
        color:rgba(255,255,255,0.8);
        font-size:1.5rem;
      }
      .startCircle:hover{
        background-color:#4CBF50;
        color:rgba(255,255,255,1);
        cursor:pointer;
      }

      .d-none{
        display:none;
      }

      .setting-components{
      }
      .setting-item{
        display: flex;
        flex-wrap: wrap;
        max-width: 450px;
        margin-bottom: 10px;
      }
      .setting-name{
        flex: 0 0 150px;
        padding-top: 5px;
        padding-bottom: 5px;
      }
      .setting-input{
        flex: 1 1 100px;
      }
      .i-stting{
        padding-top: 5px;
        padding-bottom: 5px;
        padding-left: 10px;
        padding-right: 10px;
      }
      .setting-btn{
        flex: 0 0 100px;
        background-color: rgba(40, 116, 240, 0.9);
        text-align: center;
        padding-top: 5px;
        padding-bottom: 5px;
        border-radius: 5px;
        cursor: pointer;
        color:rgba(255, 255, 255, 0.9);
      }
      .setting-btn:hover{
        background-color: rgba(40, 116, 240, 1);
        color:rgba(255, 255, 255, 1);
      }
      .cal-seperation{
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .heading-text{
        font-size: 1.3rem;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .headtwo{
        font-size: 1.2rem;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .filter-text{

      }
      .filter-components{
        display: inline-block;
      }
      .filter-item{
        display: flex;
      }
      .filter-name{
        border-style: solid;
        border-color: rgba(76, 175, 140, 1);
        padding: 5px 10px;
        border-width: thin;
        font-size: 1.1rem;
        border-radius: 2px;
        margin-right: 20px;
      }
      .filter-name:hover{
        background-color: rgba(76, 175, 80, 1);
        cursor: pointer;
      }
      .filter-selected{
        background-color:rgba(76, 175, 80, 1);
      }
      .filer-result-container{
        display: flex;
        flex-wrap: nowrap;
      }
      .filer-name-text{
        margin-right: 10px;
      }

      .efficiency-value-wr{
        margin-top: 10px;
        margin-bottom: 10px;
        width: 150px;
        text-align: center;
        padding-top: 30px;
        padding-bottom: 30px;
        text-align: center;
        border-radius: 20px;
        background-color: green;
        font-size: 1.8rem;
        color: white;
      }
      .cal-result{
        margin-right:20px;
      }
      .myChart{
        width:100%;
      }
      .downloadData{
        display: flex;
        flex-wrap: wrap;
      }
      .downloadBtn{
        margin: 20px 20px 20px 0px;
        padding: 10px 20px;
        width:200px;
        text-align: center;
        background-color: rgba(40, 116, 240, 0.9);
        font-size: 1.3em;
        border-radius: 5px;
        color:rgba(255, 255, 255, 0.9);
      }
      .downloadBtn:hover{
        cursor: pointer;
        background-color: rgba(40, 116, 240, 1);
        color:rgba(255, 255, 255, 1);
      }
      .footer{
        margin-top: 20px;
        padding-top: 10px;
        padding-bottom: 10px;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.2);
      }
      .footer-container{
        display: flex;
        flex-wrap: wrap;
      }
      .footer-block{
        margin:10px 20px;
      }

      .footer-block1{
        flex: 1 0 300px;
      }
      .footer-block2{
        flex: 1 0 300px;
      }
      .footer-block3{
        flex: 1 0 200px;
      }

      .footer-blockname{
        color: rgba(0, 0, 0, 0.9);
        font-size: 1.2rem;
        margin-bottom: 10px;
      }
      .fitemLink{
        text-decoration: none;
        color: rgba(0, 0, 0, 0.7);
      }
      .fitemLink:hover{
        color: rgba(0, 0, 0, 1);
      }
      .fitemText{
        margin-top: 7px;
        margin-bottom: 7px;
      }
      .avater{
        height: 50px;
        width:50px;
        border-radius: 50%;
      }
      .contributers{
        display: flex;
        flex-wrap: wrap;
      }
      .contributer-wr{
        margin:5px;
      }
      .reset-wr{
        position: relative;
        width: 100%
      }
      .reset{
        position: absolute;
        right:0px;
        cursor: pointer;
        top:-10px;
      }
      .data-upload-icon{
        padding-left: 20px;
        cursor: pointer;
      }
      .fileChooseModel-wr{
        width:100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7);
        position: absolute;
        top:0px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fileChooseModel-container{
        width:300px;
        height: 200px;
        background-color: rgba(255, 255, 255, 1);
        display: flex;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fileChooseModel{
        width: 150px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-style: solid;
        border-width: 1px;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
        font-size: 1.2rem;
        color: white;
        background-color: rgba(0, 100, 255, 1);

      }

    </style>
    <script src="js/axios.min.js" charset="utf-8"></script>
    <script src="js/chart.js@2.8.0"></script>
    <script src="js/chartjs-plugin-annotation.min.js"></script>
    <script src="js/chartjs-plugin-draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
    <script src="js/statistics.min.js"></script>
    <script src="js/papaparse.min.js"></script>
    <script type="text/javascript">
      //Supporting functions
      function getClass(className){
         return document.getElementsByClassName(className)[0]
      }

      function downloadFile(data, fileName, type="text/plain") {
        const a = document.createElement("a");
        a.style.display = "none";
        document.body.appendChild(a);
        a.href = window.URL.createObjectURL(
          new Blob([data], { type })
        );
        a.setAttribute("download", fileName);
        a.click();
        window.URL.revokeObjectURL(a.href);
        document.body.removeChild(a);
      }
    </script>
    <script type="text/javascript">
      // Static variable definition
      var staticData={
        ip:'192.168.0.185',
        refreshRate: 20000
      }


      window.onload=init;
      var initialTime = new Date();
      initialData={
        time:initialTime.getTime()
      }
      function initializeData(){
        dataHub=[];
        indiData={
          index:[],
          NP_0point3: [],
          NP_0point5: [],
          NP_1point0: [],
          NP_2point5: [],
          NP_5point0: [],
          NP_10: [],
          PM1point0_ATM: [],
          PM1point0_CF: [],
          PM2point5_CF: [],
          PM2point5_ATM: [],
          PM10_ATM: [],
          PM10_CF: [],
          Time_passed: [],
          my_time:[]
        }
      }
      index=0
      var dynamicData={
        data:[]
      }
      function setDynamicData(name){
        var dd=[]
        for(var i=0; i<indiData['my_time'].length; i++){
          dd.push({x:indiData['my_time'][i], y:indiData[name][i]})
        }
        dynamicData.data=dd;
      }
      function updateChart(){
        var currentParticleDimension=getClass('i-particle-dimension').value;
        setDynamicData(currentParticleDimension)
        chart.data.datasets[0].data=dynamicData.data;
        chart.update();
      }
      function init(){
        initializeData()
        getClass('startCircle').addEventListener('click', startProcess, false);
        getClass('i-particle-dimension').addEventListener('change', changeGraph, false);
        getClass('downloadBtn').addEventListener('click', downloadData, false);
        getClass('downloadAllBtn').addEventListener('click', downloadAllData, false);
        getClass('efficiency-name').addEventListener('click', toggleEfficiency, false);
        getClass('advanced-setting-icon').addEventListener('click', toggleAdvancedSetting, false);
        getClass('data-running-icon').addEventListener('click', toggleDataRequest, false);
        getClass('statistics-name').addEventListener('click', toggleStatistics, false);
        getClass('ip-set').addEventListener('click', setIP, false);
        getClass('rr-set').addEventListener('click', setRefreshRate, false);
        getClass('gc-set').addEventListener('click', setGraphColor, false);
        getClass('gbgc-set').addEventListener('click', setGraphBackground, false);
        getClass('downloadGraphBtn').addEventListener('click', downloadGraph, false);
        getClass('reset').addEventListener('click', resetZoom, false);
        getClass('data-upload-icon').addEventListener('click', loadNew, false);
        getClass('fileChooseModel').addEventListener('click', uploadFile, false);
        getClass('i-upload').addEventListener('change', processFile, false);

        addFooter();
        checkDataOperner()
      }

      function checkDataOperner(){
        var location= window.location.href;
        if(location.slice(location.length-1, location.length)=='#'){
          processFileOpen();
        }
      }

      function processFileOpen(){
        getClass('startCircle').click();
        //getClass('data-running-icon').click();
        //toggleDataRequest()
        getClass('fileChooseModel-wrc').classList.toggle('d-none')
      }

      function resetZoom(){
        chart.resetZoom();
        getClass('reset').classList.add('d-none')
      }


      function setIP(){
        staticData.ip=getClass('i-ip').value;
        stopData();
        restartData();
      }
      function setRefreshRate(){
        staticData.refreshRate=getClass('i-refreshRate').value;
        stopData();
        restartData();
      }
      function setGraphColor(){
        chart.data.datasets[0].borderColor=getClass('i-graphColour').value;
        chart.update()
      }
      function setGraphBackground(){
        chart.data.datasets[0].backgroundColor=getClass('i-graphBackground').value;
        chart.update()
      }
      function startProcess(){
        getClass('startContainer').classList.toggle('d-none');
        getClass('container-wr').classList.toggle('d-none');
        plot(indiData.my_time, indiData.NP_0point3, 'Data corresponding to 0.3 um counts')
        getData();
        dataRequestHandler=window.setInterval(function(){
          getData()
        }, staticData.refreshRate)

      }

      function toggleAdvancedSetting(){
        getClass('setting').classList.toggle('d-none')
      }


      async function getData(){
        var latestdata= await axios.get('http://'+staticData.ip);
        addData(latestdata.data)
        return latestdata.data;
      }

      function addData(latestData){
        indiData.index.push(indiData.index.length+1)
        indiData.NP_0point3.push(parseFloat(latestData['NP_0.3'])),
        indiData.NP_0point5.push(parseFloat(latestData['NP_0.5'])),
        indiData.NP_1point0.push(parseFloat(latestData['NP_1.0'])),
        indiData.NP_2point5.push(parseFloat(latestData['NP_2.5'])),
        indiData.NP_5point0.push(parseFloat(latestData['NP_5.0'])),
        indiData.NP_10.push(parseInt(parseFloat['NP_10'])),
        indiData.PM1point0_ATM.push(parseFloat(latestData['PM1.0_ATM'])),
        indiData.PM1point0_CF.push(parseFloat(latestData['PM1.0_CF'])),
        indiData.PM2point5_CF.push(parseFloat(latestData['PM2.5_CF'])),
        indiData.PM2point5_ATM.push(parseFloat(latestData['PM2.5_ATM'])),
        indiData.PM10_ATM.push(parseFloat(latestData['PM10_ATM'])),
        indiData.PM10_CF.push(parseFloat(latestData['PM10_CF'])),
        indiData.Time_passed.push(latestData['Time_passed'])
        var d = new Date();
        var n = d.getTime();

        var timeinSec=Math.round((n-initialData.time)/1000)
        indiData.my_time.push(timeinSec)
        latestData.my_time=timeinSec
        dataHub.push(latestData);
        addDataToPlot(chart, timeinSec, latestData['NP_0.3'])
      }

      var pan ={
          // Boolean to enable panning
          enabled: true,

          // Panning directions. Remove the appropriate direction to disable
          // Eg. 'y' would only allow panning in the y direction
          // A function that is called as the user is panning and returns the
          // available directions can also be used:
          //   mode: function({ chart }) {
          //     return 'xy';
          //   },
          mode: 'xy',

          rangeMin: {
              // Format of min pan range depends on scale type
              x: null,
              y: null
          },
          rangeMax: {
              // Format of max pan range depends on scale type
              x: null,
              y: null
          },

          // On category scale, factor of pan velocity
          speed: 20,

          // Minimal pan distance required before actually applying pan
          threshold: 10,

          // Function called while the user is panning
          onPan: function({chart}) { console.log(`I'm panning!!!`); },
          // Function called once panning is completed
          onPanComplete: function({chart}) { console.log(`I was panned!!!`); }
      }

      var zoom= {
            // Boolean to enable zooming
            enabled: true,

            // Enable drag-to-zoom behavior
            drag: true,

            // Drag-to-zoom effect can be customized
            // drag: {
            // 	 borderColor: 'rgba(225,225,225,0.3)'
            // 	 borderWidth: 5,
            // 	 backgroundColor: 'rgb(225,225,225)',
            // 	 animationDuration: 0
            // },

            // Zooming directions. Remove the appropriate direction to disable
            // Eg. 'y' would only allow zooming in the y direction
            // A function that is called as the user is zooming and returns the
            // available directions can also be used:
            //   mode: function({ chart }) {
            //     return 'xy';
            //   },
            mode: 'xy',

            rangeMin: {
                // Format of min zoom range depends on scale type
                x: null,
                y: null
            },
            rangeMax: {
                // Format of max zoom range depends on scale type
                x: null,
                y: null
            },

            // Speed of zoom via mouse wheel
            // (percentage of zoom on a wheel event)
            speed: 0.1,

            // Minimal zoom distance required before actually applying zoom
            threshold: 2,

            // On category scale, minimal zoom level before actually applying zoom
            sensitivity: 3,

            // Function called while the user is zooming
            onZoom: function({chart}) {
              console.log(`I'm zooming!!!`);
              getClass('reset').classList.remove('d-none')
             },
            // Function called once zooming is completed
            onZoomComplete: function({chart}) {
              console.log(`I was zoomed!!!`);
              console.log(chart);
             }
        }


        var scales={
          xAxes: [{
            type: 'linear',
            ticks: {
              beginAtZero: false,
            }
          }]
      }



      function plot(labels, dataPoint, label){
        var ctx = document.getElementById('myChart').getContext('2d');
         chart = new Chart(ctx, {
          type: 'line',
          data: {
            //labels: labels,
            datasets: [{
              label: label,
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: 'rgba(100, 99, 255, 1)',
              data: dynamicData.data
            },
            // {
            //   label: label,
            //   backgroundColor: 'rgba(255, 0, 0, 1)',
            //   borderColor: 'rgb(100, 99, 255)',
            //   data: dataPoint
            // }
          ]
          },
          // Configuration options go here
          options: {
            annotation: {
              annotations: [],
              drawTime: "afterDraw" // (default)
            },
            scales:scales,
            zoom:zoom,
            //pan:pan

          }
        });
      }

      function addDataToPlot(chart, label, data) {
        updateChart()
      }

      function changeGraph() {
        var currentParticleDimension=getClass('i-particle-dimension').value;
        var currentParticleDimensionText=this.options[this.selectedIndex].text;
        //chart.data.labels=indiData.my_time;
        chart.data.datasets[0].label='Data corresponding to '+currentParticleDimensionText;
        updateChart()
      }

      function toggleEfficiency(e){
        var datasetLength=indiData['NP_0point3'].length;
        if(datasetLength>=10){
          this.classList.toggle('filter-selected');
          getClass('efficiency-result').classList.toggle('d-none')
          var effDataStatus=getClass('efficiency-name').getAttribute('data-status')
          if(effDataStatus=='inactive'){
            addEfficiencyRange();
            getClass('efficiency-name').setAttribute('data-status', 'active')
          }else if(effDataStatus=='active'){
            removeEfficiencyRange()
            getClass('efficiency-name').setAttribute('data-status', 'inactive')
          }
        }else{
          alert('Please wait till I gather enough data');
        }

      }

      function addEfficiencyRange(){
        var datasetLength=indiData['NP_0point3'].length;
        var seperation=Math.round(datasetLength/5)
        if(datasetLength<10){
          alert('Not enough data. Please collec some more data before finding the efficiency');
        }else{
          addAnotate({value:indiData['my_time'][seperation], id:'efficiencyNoMaskStart', labelContent:'No mask Start', indexValue:seperation, color:'rgba(255,0,0,0.5)', fun:efficiencyDrag})
          addAnotate({value:indiData['my_time'][2*seperation], id:'efficiencyNoMaskStop', labelContent:'No mask end', indexValue:2*seperation, color:'rgba(255,0,0,0.5)', fun:efficiencyDrag})
          addAnotate({value:indiData['my_time'][3*seperation], id:'efficiencyMaskStart', labelContent:'Mask Start', indexValue:3*seperation, color:'rgba(0,255,0,0.5)', fun:efficiencyDrag})
          addAnotate({value:indiData['my_time'][4*seperation], id:'efficiencyMaskStop', labelContent:'Mask end', indexValue:4*seperation, color:'rgba(0,255,0,0.5)', fun:efficiencyDrag})
        }
        calculateEfficiency();
      }

      function removeEfficiencyRange(){
        removeAnotationById(chart, 'efficiencyNoMaskStart');
        removeAnotationById(chart, 'efficiencyNoMaskStop');
        removeAnotationById(chart, 'efficiencyMaskStart');
        removeAnotationById(chart, 'efficiencyMaskStop');
        chart.update();
      }

      function calculateEfficiency(){
        var currentDimension=getClass('i-particle-dimension').value
        var withoutMask=average(indiData[currentDimension].slice(parseInt(getClass('iefficiencyNoMaskStart').value),parseInt(getClass('iefficiencyNoMaskStop').value)+1))
        var withMask=average(indiData[currentDimension].slice(parseInt(getClass('iefficiencyMaskStart').value),parseInt(getClass('iefficiencyMaskStop').value)+1));
        var efficiencyValue=Math.round((1-withMask/withoutMask)*100)
        getClass('efficiency-value').innerHTML=efficiencyValue+'%';
        getClass('efficiency-value-wr').style.backgroundColor=`rgba(${(100-efficiencyValue)/100*255}, ${(efficiencyValue)/100*255}, 0, 0.9)`;
      }

      function toggleStatistics(){
        var datasetLength=indiData['NP_0point3'].length;
        if(datasetLength>=6){
          this.classList.toggle('filter-selected');
          getClass('statistics-result').classList.toggle('d-none')
          var statDataStatus=getClass('statistics-name').getAttribute('data-status')
          if(statDataStatus=='inactive'){
            addStatisticsRange();
            getClass('statistics-name').setAttribute('data-status', 'active')
          }else if(statDataStatus=='active'){
            removeStatisticsRange()
            getClass('statistics-name').setAttribute('data-status', 'inactive')
          }
        }else{
          alert('Please wait till I gather enough data');
        }

      }

      function addStatisticsRange(){
        var datasetLength=indiData['NP_0point3'].length;
        var seperation=Math.round(datasetLength/3)
        if(datasetLength<6){
          alert('Not enough data. Please collec some more data before looking at the statistics');
        }else{
          addAnotate({value:indiData['my_time'][seperation], id:'statisticsStart', labelContent:'Start', indexValue:seperation, color:'rgba(0,0,0,0.5)', fun:statisticsDrag})
          addAnotate({value:indiData['my_time'][2*seperation], id:'statisticsStop', labelContent:'End', indexValue:2*seperation, color:'rgba(0,0,0,0.5)', fun:statisticsDrag})
        }
        calculateStatistics();
      }

      function removeStatisticsRange(){
        removeAnotationById(chart, 'statisticsStart');
        removeAnotationById(chart, 'statisticsStop');
        chart.update();
      }

      function calculateStatistics(){
        var currentDimension=getClass('i-particle-dimension').value;
        var dataStart=parseInt(getClass('istatisticsStart').value);
        var dataEnd=parseInt(getClass('istatisticsStop').value);
        var dataForSatistics=[];
        for(var i=dataStart; i<=dataEnd;i++){
          dataForSatistics.push({id:i, data:indiData[currentDimension][i]})
        }
        var columns = {id: 'ordinal',data: 'interval'};
        var settings={}
        var stats = new Statistics(dataForSatistics, columns, settings);

        var dataAverage=stats.arithmeticMean("data").toFixed(2);
        var stdDev = stats.standardDeviation("data").toFixed(2);
        getClass('average-value').innerHTML=dataAverage;
        getClass('standardDeviation-value').innerHTML=stdDev;
      }

      function getAnotationById(chart, id){
        var anotations=chart.options.annotation.annotations
        for(var i=0; i<anotations.length; i++){
          if(chart.options.annotation.annotations[i].id==id){
            return chart.options.annotation.annotations[i];
          }
        }
        return false;
      }
      function removeAnotationById(chart, id){
        var anotations=chart.options.annotation.annotations
        for(var i=0; i<anotations.length; i++){
          if(chart.options.annotation.annotations[i].id==id){
             chart.options.annotation.annotations.splice(i, 1);
             return true;
          }
        }
        return false;
      }

      function addAnotate({value, id, labelContent, indexValue,color, fun}){
        getClass('i'+id).value=indexValue
        var adata={
            type: 'line',
            id:id,
            mode: 'vertical',
            scaleID: 'x-axis-0',
            value: value,
            borderColor: color,
            borderWidth: 10,
            label: {
               enabled: true,
               position: "center",
               content: labelContent
            },
            onMouseout: function(e) {

            },
            draggable: true,
            onDrag: fun
        }
        chart.options.annotation.annotations.push(adata)
        chart.update()
      }

      function efficiencyDrag(event) {

          //this.value=indiData['my_time'][event.subject.config.value];
          getClass('i'+this.id).value=getClosestIndex(indiData['my_time'], event.subject.config.value);

          chart.update()
          calculateEfficiency();
      }
      function statisticsDrag(event) {
          //this.value=indiData['my_time'][event.subject.config.value];
          getClass('i'+this.id).value=getClosestIndex(indiData['my_time'], event.subject.config.value);
          chart.update()
          calculateStatistics();
      }

      function getClosest(nums, given_num){
        const closestReducer = g => (a, b) =>
          Math.abs(g - a) < Math.abs(g - b) ? a : b

         return nums.reduce(closestReducer(given_num))

      }

      function getClosestIndex(numbers, needle) {
        return numbers.indexOf(getClosest(numbers, needle))
      }

      const average = arr => arr.reduce( ( p, c ) => parseFloat(p) + parseFloat(c), 0 ) / arr.length;

      function downloadData(){
        var currentParticleDimension=getClass('i-particle-dimension').value;
        var totalData='my_time, '+currentParticleDimension+'\n'
        for (var i = 0; i < indiData['NP_0point3'].length; i++) {
          totalData=totalData+indiData['my_time'][i]
          totalData=totalData+ ', '+indiData[currentParticleDimension][i]
          totalData=totalData+ '\n';
        }
        downloadFile(totalData, 'niskars.csv')
      }

      function downloadAllData(){
        var totalData='my_time, NP_0point3, NP_0point5, NP_1point0, NP_2point5, NP_5point0, NP_10, PM1point0_ATM, PM1point0_CF, PM2point5_CF, PM2point5_ATM, PM10_ATM, PM10_CF, Time_passed \n';
        for (var i = 0; i < indiData['NP_0point3'].length; i++) {
          totalData=totalData+indiData['my_time'][i]
          totalData=totalData + ', ' +indiData['NP_0point3'][i]
          totalData=totalData+ ', '+indiData['NP_0point5'][i]
          totalData=totalData+ ', '+indiData['NP_1point0'][i]
          totalData=totalData+ ', '+indiData['NP_2point5'][i]
          totalData=totalData+ ', '+indiData['NP_5point0'][i]
          totalData=totalData+ ', '+indiData['NP_10'][i]
          totalData=totalData+ ', '+indiData['PM1point0_ATM'][i]
          totalData=totalData+ ', '+indiData['PM1point0_CF'][i]
          totalData=totalData+ ', '+indiData['PM2point5_CF'][i]
          totalData=totalData+ ', '+indiData['PM2point5_ATM'][i]
          totalData=totalData+ ', '+indiData['PM10_ATM'][i]
          totalData=totalData+ ', '+indiData['PM10_CF'][i]
          totalData=totalData+ ', '+indiData['Time_passed'][i]
          totalData=totalData+ '\n';
        }
        downloadFile(totalData, 'skimasasa.csv')
      }

      function stopData(){
        clearInterval(dataRequestHandler);
      }
      function restartData(){
        dataRequestHandler=window.setInterval(function(){
          getData()
        }, staticData.refreshRate)
      }

      function toggleDataRequest(){
        var datastatus=getClass('data-running-icon').getAttribute('data-status');
        getClass('data-status-icon').classList.toggle('fa-spin');
        if(datastatus=='on'){
          stopData()
          getClass('data-running-icon').setAttribute('data-status', 'off')
        }else if(datastatus=='off'){
          restartData();
          getClass('data-running-icon').setAttribute('data-status', 'on')
        }
      }


      function shuffleArray(array) {
          for (var i = array.length - 1; i > 0; i--) {
              var j = Math.floor(Math.random() * (i + 1));
              var temp = array[i];
              array[i] = array[j];
              array[j] = temp;
          }
      }


      function addFooter(){
        var contributers=[{name: 'Emroj Hossain', link:'https://www.linkedin.com/in/emroj/', photo:'images/emroj.png'},
                          {name: 'Soumen Das', link:'https://www.tifr.res.in/~softmatter/soumen.html', photo:'images/soumen.jpg'},
                          {name: 'Satyanu Bhadra', link:'https://www.tifr.res.in/~softmatter/satyanu.html', photo:'images/satyanu.jpg'},
                          {name: 'Harsh Jain', link:'https://www.tifr.res.in/~softmatter/harsh.html', photo:'images/harsh.jpg'},
                          {name: 'Prof. Shankar Ghosh', link:'https://www.tifr.res.in/~softmatter/shankar.html', photo:'images/shankar.jpg'},
                          {name: 'Prof Arnab Bhattacharya', link:'https://www.tifr.res.in/~dcmpms/arnab_bhattacharya.php', photo:'images/arnab.png'}
                        ]
        shuffleArray(contributers)
        contributerHTML=''
        for (var j=0; j<contributers.length; j++){
          contributerHTML=contributerHTML+`<div class="footer-item-wr contributer-wr"><a class="profileLink fitemLink" href="${contributers[j].link}"><div class="avater contributer" style="background:url(${contributers[j].photo});   background-size: cover;"></div></a></div>`
        }
        getClass('contributers').innerHTML=contributerHTML
      }

      function downloadGraph(){
        var link = document.createElement('a');
        link.download = 'Graph.png';
        link.href = document.getElementById('myChart').toDataURL()
        link.click();
      }

      function loadNew(){
         window.open("#");
      }

      function uploadFile(){
        getClass('i-upload').click();
      }

      function processFile(){
        getClass('fileChooseModel-wrc').classList.add('d-none')
        console.log('Hello I am in processFile');
        var fileInput=getClass('i-upload');
        Papa.parse(fileInput.files[0], {
        	complete: function(results) {
        		console.log(results);
            stopAll()
            updateAllData(results.data)
        	}
        });
      }

      function stopAll(){
        getClass('data-running-icon').click()
      }



      function updateAllData(data){
        initializeData()
        var  vnames=data[0]
        for(var i=1; i<data.length; i++){
          for (var j=0; j<vnames.length; j++){
            try {
              indiData[vnames[j].trim()].push(data[i][j])
            }
            catch(err) {
            console.log(err.message);
            }
          }
        }
        updateChart()
      }



    </script>
  </head>
  <body>
    <div class="wr">
      <div class="header">
        Face Mask Filtration Efficiency Tester
      </div>
      <div class="container-wr d-none">
        <div class="container">
          <div class="container-inside">
            <div class="viewOptions">
              <div class="configuration-text heading-text">
                Configuration
              </div>
              <div class="particle">
                <div class="particle-text">
                  Particle size:
                </div>
                <select class="i-particle-dimension" name="i-particle-dimension">
                  <option value="NP_0point3">0.3 &mu;m counts</option>
                  <option value="NP_0point5">0.5 &mu;m counts</option>
                  <option value="NP_1point0">1.0  &mu;m counts</option>
                  <option value="NP_2point5">2.5  &mu;m counts</option>
                  <option value="NP_5point0">5.0  &mu;m counts</option>
                  <option value="NP_10">10  &mu;m counts</option>
                  <option value="PM1point0_ATM">1.0 &mu;m concentration (&mu;g/m^3) atmospheric</option>
                  <option value="PM1point0_CF">1.0 &mu;m concentration (&mu;g/m^3) CF=1</option>
                  <option value="PM2point5_CF">2.5 &mu;m concentration (&mu;g/m^3) CF=1</option>
                  <option value="PM2point5_ATM">2.5 &mu;m concentration (&mu;g/m^3) atmospheric</option>
                  <option value="PM10_ATM">10 &mu;m concentration (&mu;g/m^3) atmospheric</option>
                  <option value="PM10_CF">10 &mu;m concentration (&mu;g/m^3) CF=1</option>
                </select>

                <div class="advanced-setting-icon">
                  <i style="font-size:24px" class="fa fa-wrench"></i>
                </div>
                <div class="data-running-icon" data-status='on'>
                  <i style="font-size:24px" class="fa fa-spin  data-status-icon">&#xf013;</i>
                </div>
                <div class="data-upload-icon" data-status='on'>
                  <i style="font-size:24px" class="fa fa-upload" aria-hidden="true"></i>
                </div>
              </div>

              <div class="setting d-none">
                <div class="setting-text heading-text">
                  Advance setting
                </div>
                <div class="setting-options">
                  <div class="setting-item">
                    <div class="setting-name setting-components">
                      IP:
                    </div>
                    <div class="setting-input setting-components">
                      <input class="i-ip i-stting" type="text" name="i-ip" value="192.168.0.185">
                    </div>
                    <div class="setting-btn setting-components ip-set">
                      Set
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-name setting-components">
                      RefreshRate (ms):
                    </div>
                    <div class="setting-input setting-components">
                      <input class="i-refreshRate i-stting" type="text" name="i-refreshRate" value="20000">
                    </div>
                    <div class="setting-btn setting-components rr-set">
                      Set
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-name setting-components">
                      Graph colour:
                    </div>
                    <div class="setting-input setting-components">
                      <input class="i-graphColour i-stting" type="text" name="i-graphColour" value="rgba(100, 99, 255, 1)">
                    </div>
                    <div class="setting-btn setting-components gc-set">
                      Set
                    </div>
                  </div>
                  <div class="setting-item">
                    <div class="setting-name setting-components">
                      Graph BG colour:
                    </div>
                    <div class="setting-input setting-components">
                      <input class="i-graphBackground i-stting" type="text" name="i-graphColour" value="rgba(255, 255, 255,0)">
                    </div>
                    <div class="setting-btn setting-components gbgc-set">
                      Set
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chart-container" style="position: relative;">
              <div class="reset-wr">
                <div class="reset d-none">
                  <i class="reset-icon fa fa-search-minus fa-2x"></i>
                </div>
              </div>
              <canvas id="myChart"></canvas>
            </div>
            <div class="calculate-container">
              <div class="filters">
                <div class="filter-text heading-text">
                  Add calculator to graph
                </div>
                <div class="filter-items">
                  <div class="efficiency-item filter-item">
                    <div class="efficiency-name filter-name filter-components" data-status='inactive'>
                      Efficiency
                    </div>
                    <div class="statistics-name filter-name filter-components" data-status='inactive'>
                      Data statistics
                    </div>
                    <input class="iefficiencyNoMaskStart" type="hidden" name="" value="">
                    <input class="iefficiencyNoMaskStop" type="hidden" name="" value="">
                    <input class="iefficiencyMaskStart" type="hidden" name="" value="">
                    <input class="iefficiencyMaskStop" type="hidden" name="" value="">
                    <input class="istatisticsStart" type="hidden" name="" value="">
                    <input class="istatisticsStop" type="hidden" name="" value="">
                  </div>
                </div>

                <div class="filter-result">
                  <!-- <hr class="cal-seperation"> -->
                  <div class="filer-result-container headtwo">
                    <div class="efficiency-result d-none cal-result">
                      <div class="filer-name-text">
                        Calculated Efficiency:
                      </div>
                      <div class="efficiency-value-wr">
                        <div class="efficiency-value filter-value">
                          Null
                        </div>
                      </div>
                    </div>
                    <div class="statistics-result d-none cal-result">
                      <div class="filer-name-text">
                        Data statistics:
                      </div>
                      <div class="statistics-value-wr">
                        Average :<div class="average-value filter-value">
                          Null
                        </div>
                        Standard Deviation: <div class="standardDeviation-value filter-value">
                          Null
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- <hr class="cal-seperation"> -->
                </div>
              </div>
            </div>
            <div class="downloadData">
              <div class="downloadBtn">
                Download current data
              </div>
              <div class="downloadAllBtn downloadBtn">
                Download all data
              </div>
              <div class="downloadGraphBtn downloadBtn">
                Download graph
              </div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="footer-container">
            <div class="footer-block footer-block1">
              <div class="footer-items-wr">
                <div class="footer-blockname">
                  Related links
                </div>
                <div class="footer-items">
                  <div class="fitem-wr">
                    <a class="fitemLink" href="https://arxiv.org/abs/2004.13641"><div class="fitemText">Publications</div></a>
                    <a class="fitemLink" href="https://www.youtube.com/watch?v=g4IA0ZvEA3Y"><div class="fitemText">Mask recharging</div></a>
                    <a class="fitemLink" href="https://www.youtube.com/watch?v=BYmyFGL4pKI"><div class="fitemText">Science behind face mask</div></a>
                  </div>
                </div>

              </div>
            </div>
            <div class="footer-block footer-block2">
              <div class="footer-items-wr">
                <div class="footer-blockname">
                  More about design
                </div>
                <div class="footer-items">
                  <div class="fitem-wr">
                    <a class="fitemLink" href="https://github.com/shescitech/TIFR_Mask_Efficiency"><div class="fitemText">Github</div></a>
                    <a class="fitemLink" href="https://github.com/shescitech/TIFR_Mask_Efficiency/tree/master/design"><div class="fitemText">Mask tester design</div></a>
                    <a class="fitemLink" href="https://github.com/shescitech/TIFR_Mask_Efficiency/tree/master/Arduino"><div class="fitemText">Arduino code</div></a>
                    <a class="fitemLink" href="https://github.com/shescitech/TIFR_Mask_Efficiency/tree/master/web"><div class="fitemText">Web Interface</div></a>
                  </div>
                </div>

              </div>

            </div>
            <div class="footer-block footer-block3">
              <div class="footerblock-wr">
                <div class="footer-items-wr">
                  <div class="footer-blockname">
                    Contributors
                  </div>
                  <div class="footer-item-wr contributers">
                    <div class="avater">

                    </div>
                    <div class="name">
                      Hello
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="startContainer">
        <div class="startCircle">
          <div class="startBtn">
            Start
          </div>
        </div>
      </div>
    </div>
    <div class="fileChooseModel-wrc d-none">
      <div class="fileChooseModel-wr">
        <div class="fileChooseModel-container">
          <input class="i-upload d-none" type="file" name="myfile" value="" accept=".csv">
          <div class="fileChooseModel">
            Choose your file
          </div>

        </div>
      </div>
    </div>
  </body>
</html>
